<!DOCTYPE html>
<html lang="en">
<head>
	<title>新同文堂</title>
	<meta charset="utf-8">
	<script src="./lib/tongwen_opera_init.js"></script>
	<script type="text/javascript">
		// 合併新舊版本的設定值
		function mergeConfig() {
			if (typeof localStorage["tongwen"] === "undefined") {
				localStorage["tongwen"] = JSON.stringify(tongwen);
			} else {
				oTongwen = JSON.parse(localStorage["tongwen"]);
				for (var i in oTongwen) {
					if (i == "version") continue;
					tongwen[i] = oTongwen[i];
				}
				if (typeof tongwen.userPhrase["enable"] === "undefined") {
					tongwen.userPhrase["enable"] = false;
				}
				localStorage["tongwen"] = JSON.stringify(tongwen); // 回存設定
			}
		}

		// 重新載入設定值
		function reloadConfig() {
			tongwen = JSON.parse(localStorage["tongwen"]);
		}

		// 點選圖示動作
		function iconAction(tab) {
			switch (tongwen.iconAction) {
				case "trad": tab.postMessage("btnTrad"); break;
				case "simp": tab.postMessage("btnSimp"); break;
				default    : tab.postMessage("btnAuto");
			}
		}

		function docLoaded(tab, uri) {
			// 自動轉換
			var zhflag = '';
			if (tongwen.urlFilter.enable) {
				// zhflag = urlFilterAction(uri);
			}
			if (zhflag === '') zhflag = tongwen.autoConvert;

			// 轉換標點符號
			if (tongwen.symConvert) {
			}
			
			opera.postError(zhflag);
			switch (zhflag) {
				case 'trad': tab.postMessage("btnTrad"); break;
				case 'simp': tab.postMessage("btnSimp"); break;
				default:
			}
		}

		var conList = [];
		window.addEventListener("load", function TongWenInit() {
			var btnTongwen = null, uiToolbarProperties = null;

			mergeConfig();

			uiToolbarProperties = {
				disabled: false,
				title: '新同文堂',
				icon: './icons/icon-16.png',
				onclick: function () {
					var tab = opera.extension.tabs.getFocused();
					iconAction(tab);
				}
			}

			btnTongwen = opera.contexts.toolbar.createItem(uiToolbarProperties);
			opera.contexts.toolbar.addItem(btnTongwen);

			opera.extension.onmessage = function(event) {
				// opera.postError(event.origin);
				switch (event.data) {
					case 'Loaded':
						docLoaded(event.source, event.origin);
					break;
				}
			};
		}, false );
	</script>
</head>
<body>

</body>
</html>